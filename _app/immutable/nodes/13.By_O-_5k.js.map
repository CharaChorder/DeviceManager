{"version":3,"file":"13.By_O-_5k.js","sources":["../../../../../../src/routes/sandbox/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import type { ChannelEventData } from \"../(app)/plugin/plugin-types\";\n\n  let ongoingRequest: Promise<unknown> | undefined = undefined;\n  let resolveRequest: ((data: unknown) => void) | undefined = undefined;\n  let source: MessageEventSource | undefined = undefined;\n\n  async function post(channel: string, args: unknown[]) {\n    while (ongoingRequest) {\n      await ongoingRequest;\n    }\n    ongoingRequest = new Promise((resolve) => {\n      resolveRequest = resolve;\n      source?.postMessage([channel, args], { targetOrigin: \"*\" });\n    });\n    ongoingRequest.then(() => {\n      ongoingRequest = undefined;\n    });\n    return ongoingRequest;\n  }\n\n  function onMessage(event: MessageEvent<ChannelEventData>) {\n    if (\"response\" in event.data) {\n      resolveRequest?.(event.data.response);\n    } else {\n      source = event.source ?? undefined;\n\n      const Action = event.data.actionCodes;\n      Object.assign(\n        Action,\n        Object.fromEntries(\n          Object.values(event.data.actionCodes)\n            .filter((it) => !!it.id)\n            .map((it) => [it.id, it]),\n        ),\n      );\n\n      new Function(\"Action\", \"Chara\", event.data.script)(\n        Action,\n        Object.fromEntries(\n          event.data.charaChannels.map((name) => [\n            name,\n            (...args: unknown[]) => post(name, args),\n          ]),\n        ),\n      );\n    }\n  }\n</script>\n\n<svelte:window on:message={onMessage} />\n"],"names":["ctx","ongoingRequest","resolveRequest","source","post","channel","args","resolve","onMessage","event","Action","it","name"],"mappings":"8LAkD2BA,EAAS,CAAA,CAAA,mDA/C9B,IAAAC,EACAC,EACAC,iBAEWC,EAAKC,EAAiBC,EAAe,MAC3CL,SACCA,EAER,OAAAA,EAAc,IAAO,QAASM,GAAO,CACnCL,EAAiBK,EACjBJ,GAAQ,YAAa,CAAAE,EAASC,CAAI,EAAA,CAAK,aAAc,GAAG,CAAA,IAE1DL,EAAe,KAAI,IAAA,CACjBA,EAAiB,SAEZA,EAGA,SAAAO,EAAUC,EAAqC,IAClD,aAAcA,EAAM,KACtBP,IAAiBO,EAAM,KAAK,QAAQ,OAEpCN,EAASM,EAAM,QAAU,OAEnB,MAAAC,EAASD,EAAM,KAAK,YAC1B,OAAO,OACLC,EACA,OAAO,YACL,OAAO,OAAOD,EAAM,KAAK,WAAW,EACjC,OAAQE,GAAS,CAAA,CAAAA,EAAG,EAAE,EACtB,IAAKA,GAAQ,CAAAA,EAAG,GAAIA,CAAE,CAAA,CAAA,CAAA,EAIzB,IAAA,SAAS,SAAU,QAASF,EAAM,KAAK,MAAM,EAC/CC,EACA,OAAO,YACLD,EAAM,KAAK,cAAc,IAAKG,GAAI,CAChCA,EAAI,IACAN,IAAoBF,EAAKQ,EAAMN,CAAI,CAAA,CAAA,CAAA,CAAA"}